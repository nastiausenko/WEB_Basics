<!doctype html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Пости</title>
    <link rel="stylesheet" href="/home.css">
</head>
<body>

<div class="header">
    <div><a href="/api/v2/home">Home</a></div>
    <div id="userSection"></div>
</div>

<div class="container" id="postsContainer">

</div>

<script>
    async function loadUser() {
        const token = localStorage.getItem('token');
        const userSection = document.getElementById('userSection');

        if (!token) {
            userSection.innerHTML = `<a href="/api/v2/register" class="signup-btn">Sign up</a>`;
            return;
        }

        try {
            const res = await fetch('/api/v1/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                const user = await res.json();
                userSection.innerHTML = `
                <div class="user-menu">
                    <span class="username">${user.username}</span>
                    <div class="dropdown" id="userDropdown">
                        <button id="myPostsBtn" class="dropdown-item">My posts</button>
                        <button id="logoutBtn">Logout</button>
                    </div>
                </div>
            `;

                const usernameEl = document.querySelector('.username');
                const dropdown = document.getElementById('userDropdown');
                usernameEl.addEventListener('click', () => {
                    dropdown.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-menu')) {
                        dropdown.classList.remove('show');
                    }
                });

                document.getElementById('myPostsBtn').addEventListener('click', () => {
                    window.location.href = '/api/v2/posts';
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '/api/v2/home';
                });

            } else {
                localStorage.removeItem('token');
                userSection.innerHTML = `<a href="/api/v2/register" class="signup-btn">Sign up</a>`;
            }
        } catch (e) {
            console.error(e);
            userSection.innerHTML = `<a href="/api/v2/register" class="signup-btn">Sign up</a>`;
        }
    }

    async function loadPosts() {
        try {
            const res = await fetch('/api/v1/posts/public');
            if (!res.ok) throw new Error('Не вдалося завантажити пости');

            const posts = await res.json();
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';

            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.innerHTML = `
                <div class="post-header">
                    <span>${new Date(post.createdAt).toLocaleString()}</span>
                    <span>${post.username || 'Unknown'}</span>
                </div>
                <div class="post-title">${post.title}</div>
                <div class="post-content">${post.content}</div>
            `;
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
            alert('Сталася помилка при завантаженні постів');
        }
    }

    loadUser();
    loadPosts();
</script>

</body>
</html>