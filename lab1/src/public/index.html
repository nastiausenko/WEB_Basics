<!doctype html>
<html>

<head>
  <title>Чат з кімнатами</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="joinForm">
    <form method="POST" action="/login">
      <input name="username" placeholder="Твоє ім'я" required>
      <input name="room" placeholder="Назва кімнати" required>
      <button type="submit">Приєднатися</button>
    </form>
  </div>

  <div id="chatContainer" style="display:none;">
    <div id="sidebar">
      <div class="room-bubble">
        <h3>Кімната: <span id="roomName"></span></h3>
        <h4>Користувачі:</h4>
        <ul id="users"></ul>
      </div>
      <button id="logoutBtn">Вийти</button>
    </div>
    <div id="mainChat">
      <ul id="messages"></ul>
      <form id="chatForm" action="">
        <input id="m" autocomplete="off" placeholder="Введи повідомлення..." />
        <button>Send</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    $(function () {
      var socket = io();
      function usernameToBlueShade(username) {
        const base = { r: 217, g: 234, b: 253 };

        let hash = 0;
        for (let i = 0; i < username.length; i++) {
          hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }

        const shift = (hash % 61) - 30;

        const r = Math.min(255, Math.max(0, base.r + shift));
        const g = Math.min(255, Math.max(0, base.g + shift));
        const b = Math.min(255, Math.max(0, base.b + shift));

        return `rgb(${r}, ${g}, ${b})`;
      }

      function addMessage(msg) {
        const li = $('<li>').addClass(msg.type === 'system' ? 'system-message' : 'user-message');
        if (msg.type === 'user') {
          const splitIndex = msg.text.indexOf(':');
          const username = msg.text.substring(0, splitIndex);
          const messageText = msg.text.substring(splitIndex + 1);

          const name = $('<div>').addClass('msg-name').text(username);
          const text = $('<div>').addClass('msg-text').text(messageText);

          li.append(name).append(text);

          li.css('background-color', usernameToBlueShade(username));
        } else {
          li.text(msg.text);
        }
        $('#messages').append(li);
        $('#messages').scrollTop($('#messages')[0].scrollHeight);
      }


      socket.on("connect", function () {
        $('#joinForm').hide();
        $('#chatContainer').show();
      });

      $('#chatForm').submit(function () {
        const message = $('#m').val().trim();
        if (!message) return false; 

        socket.emit('chat message', message);
        $('#m').val('');
        return false;
      });

      $('#logoutBtn').click(function () {
        $.post('/logout', function () {
          window.location.href = '/login';
        });
      });

      socket.on('chat history', function (history) {
        $('#messages').empty();
        history.forEach(msg => addMessage(msg));
      });

      socket.on('chat message', function (msg) {
        addMessage(msg);
      });

      socket.on('roomData', function ({ room, users }) {
        $('#roomName').text(room);
        $('#users').empty();
        users.forEach(u => {
          $('#users').append($('<li>').text(u));
        });
      });

      socket.on("forceLogout", function () {
        alert("Немає сесії, увійди заново");
        window.location.href = "/login";
      });
    });
  </script>
</body>

</html>