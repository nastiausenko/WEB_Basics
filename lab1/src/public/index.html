<!doctype html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Чат</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="chatContainer" style="display:none;">
    <div id="sidebar">
      <div class="room-bubble">
        <h3>Кімната: <span id="roomName"></span></h3>
        <h4>Користувачі:</h4>
        <ul id="users"></ul>
        <div id="currentUser"></div>
      </div>
      <button id="logoutBtn">Вийти</button>
    </div>
    <div id="mainChat">
      <ul id="messages"></ul>
      <form id="chatForm">
        <input id="m" autocomplete="off" placeholder="Введіть повідомлення..." />
        <button>Send</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    $(function () {
      const socket = io();
      let currentUser = '';

      const usernameToBlueShade = username => {
        const base = { r: 217, g: 234, b: 253 };

        let hash = 0;
        for (let i = 0; i < username.length; i++) {
          hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }

        const shift = (hash % 61) - 30;
        return `rgb(${Math.min(255, Math.max(0, base.r + shift))},${Math.min(255, Math.max(0, base.g + shift))},${Math.min(255, Math.max(0, base.b + shift))})`;
      };

      const addMessage = msg => {
        const li = $('<li>').addClass(msg.type === 'system' ? 'system-message' : 'user-message');

        if (msg.type === 'user') {
          const [username, ...textParts] = msg.text.split(':');
          const messageText = textParts.join(':');
          li.append($('<div>').addClass('msg-name').text(username));
          li.append($('<div>').addClass('msg-text').text(messageText));
          li.css('background-color', usernameToBlueShade(username));
        } else li.text(msg.text);

        $('#messages').append(li);
        $('#messages').scrollTop($('#messages')[0].scrollHeight);
      };

      socket.on('currentUser', username => currentUser = username);
      socket.on('connect', () => $('#chatContainer').show());
      socket.on('chat history', history => history.forEach(addMessage));
      socket.on('chat message', addMessage);
      socket.on('forceLogout', () => { alert("Немає сесії"); window.location.href = "/login"; });

      socket.on('roomData', ({ room, users }) => {
        $('#roomName').text(room);
        document.title = room;
        $('#users').empty();
        users.forEach(u => $('#users').append($('<li>').text(u).css('font-weight', u === currentUser ? 'bold' : 'normal')));
      });

      $('#chatForm').submit(function () {
        const message = $('#m').val().trim();
        if (!message) return false;

        socket.emit('chat message', message);
        $('#m').val('');
        return false;
      });

      $('#logoutBtn').click(() => $.post('/logout', () => window.location.href = '/login'));
    });
  </script>
</body>
</html>